import { Artwork } from "./data.js";

export const results = [];

//  function to get array of ID results from search.
export async function fetchIds(query) {
    // API url for searches. This gives a list of IDs. Only search paintings that have images and are highlight to reduce loading time.
    const medium = "medium=Paintings";
    const hasImages = "hasImages=true";
    const isHighlight = "isHighlight=true";
    const searchUrl = `https://collectionapi.metmuseum.org/public/collection/v1/search?${medium}&${hasImages}&${isHighlight}&q=`;
    const response = await fetch(searchUrl + query);
    const entries = await response.json();
    return entries;
}

// function to load data from API for each Id entry. If the entry is in public domain, it pushes it to results.
export async function fetchData(entries) {
    const objectInfoUrl =
        "https://collectionapi.metmuseum.org/public/collection/v1/objects/";
    for (const entry of entries.objectIDs) {
        const info = objectInfoUrl + entry;
        const response = await fetch(info);
        const data = await response.json();
        if (data.isPublicDomain) {
            results.push(
                new Artwork(
                    data.objectID,
                    data.primaryImageSmall,
                    data.title,
                    data.artistDisplayName,
                    data.artistAlphaSort,
                    data.objectDate,
                    data.objectEndDate
                )
            );
        }
    }
    saveResults();
}

//LocalStorage functions to save and restore results from search and search query status
export function saveResults() {
    localStorage.setItem("savedResults", JSON.stringify(results));
}

export function loadResults() {
    return JSON.parse(localStorage.getItem("savedResults"));
}

export function saveQueryAndStatus() {
    localStorage.setItem(
        "statusMessage",
        document.querySelector(".status-message").textContent
    );
    // textContent to simplify process, since the message was already generated by showSearchStatus.
}

export function loadQueryAndStatus() {
    return localStorage.getItem("statusMessage");
}
